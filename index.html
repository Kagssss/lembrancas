<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lembranças — caderno</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    :root { --kraft:#2b211b; --ink:#2b211b }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* Fundo */
    body{
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 10% 0%, rgba(255,255,255,.05), transparent 50%),
        radial-gradient(1000px 800px at 90% 100%, rgba(0,0,0,.15), transparent 45%),
        linear-gradient(180deg, #3b2d24 0%, #2b211b 100%);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    .stage{
      position:relative; width:100%; height:86vh; max-height:980px; 
      border-radius:18px; border:1px solid rgba(0,0,0,.4);
      overflow:hidden; display:flex; align-items:center; justify-content:center;
      perspective: 1600px; 
      background:
        repeating-linear-gradient( 45deg, rgba(0,0,0,.05) 0px, rgba(0,0,0,.05) 2px, transparent 2px, transparent 6px ),
        radial-gradient(900px 500px at 20% 0%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 500px at 80% 100%, rgba(0,0,0,.25), transparent 55%),
        #5a4637;
      box-shadow: 0 30px 60px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .book { position:relative; width:min(100%, 980px); height:100%; display:flex; align-items:center; justify-content:center; }

    /* Espiral */
    .spiral{
      position:absolute; top:12px; left:40px; right:40px; height:22px; z-index:5;
      background:
        radial-gradient(circle at 0% 50%, rgba(0,0,0,.4) 0 2px, transparent 2px) repeat-x,
        radial-gradient(circle at 0% 50%, rgba(255,255,255,.15) 0 1px, transparent 1px) repeat-x;
      background-size: 30px 22px, 30px 22px;
      background-position: left center, 15px center;
      opacity:.65;
      pointer-events:none;
    }

    .page {
      position:absolute; inset:40px 26px 26px; margin:auto;
      width:calc(100% - 52px); height:calc(100% - 66px);
      border-radius:14px;
      background:
        radial-gradient(1400px 700px at 0% 0%, rgba(255,255,255,.08), transparent 45%),
        radial-gradient(1200px 600px at 100% 100%, rgba(0,0,0,.08), transparent 45%),
        repeating-linear-gradient( 0deg, rgba(0,0,0,.02), rgba(0,0,0,.02) 2px, rgba(255,255,255,.02) 2px, rgba(255,255,255,.02) 4px ),
        linear-gradient(180deg, #d6be98 0%, #cdae83 100%);
      border:1px solid rgba(0,0,0,.25);
      box-shadow: 0 40px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.2);
      display:flex; align-items:center; justify-content:center;
      opacity:0; transform: translateZ(0) rotateX(0deg) scale(.995);
      transition: opacity .5s ease;
      overflow:hidden;
    }
    
    .page::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient( to bottom, rgba(0,0,0,.06) 0px, rgba(0,0,0,.06) 1px, transparent 1px, transparent 28px ),
        linear-gradient(90deg, rgba(180,70,70,.35) 0 2px, transparent 2px);
      background-position: left 36px top 0, left 36px top 0;
      mix-blend-mode:multiply; opacity:.18;
    }
    .page .content { width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:22px; }

    /* Foto colada */
    .photo{
      position:relative; padding:14px; background:#fffdf3;
      border:1px solid rgba(0,0,0,.18); border-radius:10px;
      box-shadow: 0 12px 22px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.7);
    }
    .photo img, .photo video{ display:block; max-width:100%; max-height:100%; object-fit:contain; border-radius:6px; }
    .photo::before, .photo::after{
      content:""; position:absolute; width:80px; height:22px; background:rgba(255,245,184,.85);
      top:-12px; border-radius:4px; box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    .photo::before{ left:16%; transform:rotate(-6deg); }
    .photo::after{ right:16%; transform:rotate(7deg); }

    .note{
      position:relative; max-width: min(760px, 92%);
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.18);
      border-radius:12px; padding:22px 20px;
      box-shadow: 0 8px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.7);
      font-family: "Patrick Hand", cursive;
      font-size: clamp(18px, 2.6vw, 22px);
      line-height: 1.5;
      color:#1f1b16;
      text-align:center;
    }
    .note::before{
      content:""; position:absolute; width:90px; height:22px; background:rgba(255,245,184,.85);
      top:-12px; left:50%; transform:translateX(-50%) rotate(-2deg);
      border-radius:4px; box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }

    /* Carta com folha pautada */
    .letter{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
    }
    .letter-paper{
      position:relative; width:min(860px, 92%); max-height:100%;
      padding: clamp(20px, 4vw, 36px) clamp(22px, 4.5vw, 44px);
      border-radius:14px;
      background:
        repeating-linear-gradient( to bottom, rgba(0,0,0,.06) 0px, rgba(0,0,0,.06) 1px, transparent 1px, transparent 28px ),
        linear-gradient(90deg, rgba(180,70,70,.35) 0 2px, transparent 2px),
        linear-gradient(180deg, #f7ecd8 0%, #f0e0c4 100%);
      border:1px solid rgba(0,0,0,.2);
      box-shadow: 0 12px 22px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.5);
      overflow:auto;
    }
    .letter h2{
      font-family:"Playfair Display", serif; font-weight:600; letter-spacing:.5px;
      text-align:center; margin:0 0 12px; color:#2b211b;
    }
    #cartaTexto{
      font-family:"Playfair Display", serif;
      font-size: clamp(15px, 2.1vw, 18px);
      line-height: 1.9;
      color: #2b211b;
      letter-spacing: .2px;
    }
    #cartaTexto p{ margin:0 0 12px; }
    #cartaTexto p+p{ text-indent:1.4em; }

    /* Flip vertical */
    .page.active{ opacity:1; }
    .flip-out{ animation: flipOut .7s ease forwards; transform-origin: 50% 0%; }
    @keyframes flipOut{
      0%{opacity:1; transform: translateZ(0) rotateX(0deg)}
      100%{opacity:0; transform: translateZ(0) rotateX(75deg)}
    }
    .flip-in{ animation: flipIn .7s ease forwards; transform-origin: 50% 100%; }
    @keyframes flipIn{
      0%{opacity:0; transform: translateZ(0) rotateX(-75deg)}
      100%{opacity:1; transform: translateZ(0) rotateX(0deg)}
    }

    /* Overlay de áudio */
    .hint{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.7); z-index:40; flex-direction:column;}
    .hint.show{display:flex}
    .pulse-heart{font-size:50px;color:#ff4d6d;animation:pulse 1.5s infinite;margin-bottom:14px}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
  </style>
</head>
<body>
  <header class="wrap">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-amber-100" style="font-family:'Playfair Display',serif">E❤️J</h1>
  </header>

  <main class="wrap">
    <section id="stage" class="stage">
      <div class="book">
        <div class="spiral" aria-hidden="true"></div>
      </div>
    </section>
  </main>

  <footer class="wrap pb-6 text-center text-sm text-amber-200/80"></footer>

  <!-- Música -->
  <audio id="audio" preload="metadata"></audio>
  <div id="audioHint" class="hint">
    <div class="pulse-heart">❤️</div>
    <div class="note bg-transparent border-none shadow-none">Toque para começar</div>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SEQUENCIA = [
      { tipo:"texto", ms:6500, texto:"Antes de tudo, obrigado por ter aceitado conversar comigo e por estar aqui agora... Eu sei que não foi fácil..." },
      { tipo:"texto", ms:4200, texto:"Por favor, vê tudo até o final." },

      { tipo:"foto", src:"fotos/1.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/2.jpg", ms:3500 },
      { tipo:"video", src:"fotos/3_compat.mp4" },
      { tipo:"foto", src:"fotos/4.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/5.jpg", ms:3500 },
      
      { tipo:"texto", ms:6000, texto:"Tudo começou tão simples, mas desde o primeiro instante eu soube que você ia ser diferente." },

      { tipo:"foto", src:"fotos/6.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/7.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/8.jpg", ms:3500 },
      { tipo:"video", src:"fotos/9.mp4" },
      { tipo:"foto", src:"fotos/10.jpg", ms:3500 },

      { tipo:"texto", ms:4200, texto:"100..." },

      { tipo:"foto", src:"fotos/11.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/12.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/13.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/14.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/15.jpg", ms:3500 },

      { tipo:"texto", ms: 3500, texto:"Toda vez que você sorria, meu mundo ficava mais leve." },

      { tipo:"foto", src:"fotos/16.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/17.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/18.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/19.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/20.jpg", ms:3500 },

      { tipo: "texto", ms: 4000, texto:"Até nos momentos ruins eu ficava bem, porque eu tinha você." },

      { tipo:"foto", src:"fotos/21.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/22.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/23.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/24.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/25.jpg", ms:3500 },

      { tipo:"texto", ms: 4000, texto:"Te amar era fácil. Difícil era imaginar um mundo sem você." },

      { tipo:"foto", src:"fotos/26.jpg", ms:3500},
      { tipo:"foto", src:"fotos/27.jpg", ms:3500},
      { tipo:"foto", src:"fotos/28.jpg", ms:3500},
      { tipo:"video", src:"fotos/29_compat.mp4" },
      { tipo:"foto", src:"fotos/30.jpg", ms:3500},

      { tipo:"texto", ms:3500, texto:"Você foi lar, abrigo, e também saudade. Tudo ao mesmo tempo." },

      { tipo:"foto", src:"fotos/31.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/32.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/33.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/34.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/35.jpg", ms:3500 },

      { tipo:"texto", ms:3500, texto:"Você foi a melhor parte da minha vida." },

      { tipo:"foto", src:"fotos/36.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/37.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/38.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/39.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/40.jpg", ms:3500 },

      { tipo:"texto", ms:4000, texto:"Vou guardar cada abraço, cada beijo, cada sorriso com muito carinho no meu coração." },

      { tipo:"foto", src:"fotos/41.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/42.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/43.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/44.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/45.jpg", ms:3500 },
      { tipo:"foto", src:"fotos/46.jpg", ms:3500 },

      { tipo:"texto", ms:5000, texto:"Obrigado por ter sido parte do meu melhor. Agora tem uma cartinha :)" },

      /* Última página (Carta) */
      { tipo:"carta" }
    ];

    const PLAYLIST = ["musicas/5.mp3","musicas/4.mp3"];
    const MUSIC_VOLUME = 0.6;
    const MUSIC_DELAY_MS = 4000;
    const DUCK_VOLUME = 0.22;      
    const IOS_MODE = "video";      
    
    const book = document.querySelector('.book');
    const audio = document.getElementById("audio");
    const audioHint = document.getElementById("audioHint");
    const isIOS = /iP(ad|hone|od)/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    /* ===== cria páginas ===== */
    const slides = SEQUENCIA.map((item, idx)=>{
      const page = document.createElement('div');
      page.className = 'page';
      const content = document.createElement('div');
      content.className = 'content';

      if(item.tipo === "texto"){
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = item.texto;
        content.appendChild(note);

      } else if(item.tipo === "foto"){
        const frame = document.createElement('div');
        frame.className = 'photo';
        const img = document.createElement('img');
        img.src = item.src; img.alt = "foto";
        const angle = ((idx%2===0)?1:-1) * (3 + (idx%3));
        frame.style.transform = `rotate(${angle}deg)`;
        frame.appendChild(img);
        content.appendChild(frame);

      } else if(item.tipo === "video"){
        const frame = document.createElement('div');
        frame.className = 'photo';
        frame.style.transform = 'rotate(0deg)';
        const v = document.createElement('video');
        v.setAttribute("playsinline",""); v.setAttribute("webkit-playsinline","");
        v.playsInline = true; v.muted = true; v.preload = "auto"; v.controls = false; v.src = item.src;
        frame.appendChild(v);
        content.appendChild(frame);
        item._videoEl = v;

      } else if(item.tipo === "carta"){
        const wrap = document.createElement('div');
        wrap.className = 'letter';
        wrap.innerHTML = `
          <div class="letter-paper">
            <h2>Uma carta</h2>
            <div id="cartaTexto"></div>
          </div>`;
        content.appendChild(wrap);
      }

      page.appendChild(content);
      book.appendChild(page);
      return { page, item };
    });

    /* ===== ÁUDIO GLOBAL / OVERLAY ===== */
    let audioCtx = null, audioUnlocked = false, track = 0, musicTimer = null;
    function ensureAudioContext(){
      if(!audioCtx){
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) { audioCtx = new Ctx(); try { audioCtx.resume(); } catch{} }
      }
    }
    function loadTrack(idx){
      if(!PLAYLIST.length) return;
      track = (idx + PLAYLIST.length) % PLAYLIST.length;
      audio.src = PLAYLIST[track]; audio.volume = MUSIC_VOLUME;
    }
    function startMusicWithDelay(){
      if(!PLAYLIST.length) return;
      clearTimeout(musicTimer);
      musicTimer = setTimeout(async ()=>{
        if (!audioUnlocked) return;
        if (!audio.src) loadTrack(0);
        try { await audio.play(); } catch { audioHint.classList.add('show'); }
      }, MUSIC_DELAY_MS);
    }
    audio.addEventListener("ended", ()=> {
      loadTrack(track + 1);
      if (audioUnlocked) { audio.play().catch(()=>{}); }
    });

    async function tryUnlockAndPlay(){
      ensureAudioContext();
      clearTimeout(musicTimer);
      if (!audio.src) loadTrack(0);
      audio.muted = false; audio.volume = MUSIC_VOLUME;
      try {
        await audio.play();
        audioUnlocked = true; audioHint.classList.remove('show'); removeUnlockListeners();
      } catch { audioHint.classList.add('show'); }
    }
    function unlockAudioHandler(){ tryUnlockAndPlay(); }
    function removeUnlockListeners(){
      window.removeEventListener('pointerdown', unlockAudioHandler);
      window.removeEventListener('touchstart', unlockAudioHandler);
      window.removeEventListener('click', unlockAudioHandler);
      window.removeEventListener('keydown', unlockAudioHandler);
      audioHint.removeEventListener('click', unlockAudioHandler);
      audioHint.removeEventListener('touchstart', unlockAudioHandler);
    }
    window.addEventListener('pointerdown', unlockAudioHandler);
    window.addEventListener('touchstart', unlockAudioHandler, { passive:true });
    window.addEventListener('click', unlockAudioHandler);
    window.addEventListener('keydown', unlockAudioHandler);
    audioHint.addEventListener('click', unlockAudioHandler);
    audioHint.addEventListener('touchstart', unlockAudioHandler, { passive:true });

    /* ===== SLIDES / VÍDEO ===== */
    let i = 0, t = null;
    function clearTimer(){ if(t){ clearTimeout(t); t=null; } }

    function safeUnmuteVideo(v){
      if(!audioUnlocked) return;
      if(isIOS && IOS_MODE==="music"){ v.muted = true; return; }
      setTimeout(()=>{ try{ v.muted=false; v.volume=1; v.play().catch(()=>{}); }catch{} }, 60);
    }

    function playVideo(v){
      const musicWasPlaying = !audio.paused;
      const prevVol = audio.volume;

      if (isIOS) {
        if (IOS_MODE === "video") { if (musicWasPlaying) audio.pause(); }
        else { if (musicWasPlaying) audio.volume = MUSIC_VOLUME; }
      } else {
        if (musicWasPlaying) audio.volume = DUCK_VOLUME;
      }

      v.muted = true; v.playsInline = true; v.currentTime = 0;
      try{ v.load(); }catch{}

      let started=false;
      const watchdog=setTimeout(()=>{
        if(!started){
          if (isIOS) {
            if (IOS_MODE === "video") { if (musicWasPlaying) audio.play().catch(()=>{}); }
            else { if (musicWasPlaying) audio.volume = MUSIC_VOLUME; }
          } else { if (musicWasPlaying) audio.volume = prevVol; }
          next();
        }
      }, 1800);

      v.onplay = () => { started=true; clearTimeout(watchdog); safeUnmuteVideo(v); };
      v.onended = () => {
        if (isIOS) {
          if (IOS_MODE === "video") { if (musicWasPlaying) audio.play().catch(()=>{}); }
          else { if (musicWasPlaying) audio.volume = MUSIC_VOLUME; }
        } else { if (musicWasPlaying) audio.volume = prevVol; }
        next();
      };
      v.onerror = () => {
        if (isIOS) {
          if (IOS_MODE === "video") { if (musicWasPlaying) audio.play().catch(()=>{}); }
          else { if (musicWasPlaying) audio.volume = MUSIC_VOLUME; }
        } else { if (musicWasPlaying) audio.volume = prevVol; }
        next();
      };

      v.play().catch(()=>{
        const tryOnTouch=()=>{ v.play().catch(()=>{}); document.removeEventListener('touchstart',tryOnTouch); };
        document.addEventListener('touchstart',tryOnTouch,{once:true,passive:true});
      });

      if(!(isIOS && IOS_MODE==="music")){
        const unmuteOnce=()=>{ v.muted=false; v.play().catch(()=>{}); v.removeEventListener('pointerdown',unmuteOnce); };
        v.addEventListener('pointerdown',unmuteOnce,{once:true});
      }
    }

    function applyFlip(prevIdx, nextIdx){
      if (prevIdx !== null && slides[prevIdx]) {
        const p = slides[prevIdx].page;
        p.classList.remove('active','flip-in');
        p.offsetWidth;
        p.classList.add('flip-out');
        setTimeout(()=>{ p.classList.remove('flip-out'); }, 750);
      }
      if (slides[nextIdx]) {
        const n = slides[nextIdx].page;
        n.classList.remove('flip-out');
        n.offsetWidth;
        n.classList.add('flip-in','active');
        setTimeout(()=>{ n.classList.remove('flip-in'); }, 750);
      }
    }

    function show(k){
      clearTimer();
      const prev = (typeof i === 'number') ? i : null;
      applyFlip(prev, k);

      const cur = slides[k].item;
      if(cur.tipo==="video"){ playVideo(cur._videoEl); }
      else if(cur.tipo==="texto"||cur.tipo==="foto"){
        const ms=Math.max(1500,cur.ms||3000);
        t=setTimeout(()=>next(),ms);
      } else if(cur.tipo==="carta"){
        carregarCarta();
      }
      i=k;
    }

    function next(){
      const n = i + 1;
      if(n >= slides.length){ return; } 
      show(n);
    }

    /* ===== CARTA ===== */
    async function carregarCarta(){
      try{
        const resp=await fetch('carta.txt?'+Date.now());
        if(!resp.ok) throw new Error('sem carta.txt');
        const raw=(await resp.text()).trim();
        const html=raw.split(/\r?\n\r?\n/).map(p=>`<p>${p.replace(/\r?\n/g,'<br>')}</p>`).join('');
        const cartaTexto=document.getElementById('cartaTexto');
        if(cartaTexto){ cartaTexto.innerHTML=html || '<p>...</p>'; }
      }catch(e){
        const cartaTexto=document.getElementById('cartaTexto');
        if(cartaTexto){ cartaTexto.innerHTML='<p>Carta indisponível. (Se estiver abrindo com file://, rode um servidor local.)</p>'; }
      }
    }

    if(SEQUENCIA.length) show(0);
    if(PLAYLIST.length){
      audioHint.classList.add('show');
    }
  </script>
</body>
</html>






